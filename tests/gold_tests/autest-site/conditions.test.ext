'''
'''
#  Licensed to the Apache Software Foundation (ASF) under one
#  or more contributor license agreements.  See the NOTICE file
#  distributed with this work for additional information
#  regarding copyright ownership.  The ASF licenses this file
#  to you under the Apache License, Version 2.0 (the
#  "License"); you may not use this file except in compliance
#  with the License.  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

import subprocess
import json
import re

def HasOpenSSLVersion(self, version):
    output = subprocess.check_output(
        os.path.join(self.Variables.BINDIR, "traffic_layout") + " info --versions --json", shell = True
    )
    json_data = output.decode('utf-8')
    openssl_str = json.loads(json_data)['openssl_str']
    exe_ver = re.search(r'\d\.\d\.\d', openssl_str).group(0)
    if exe_ver == '':
        raise ValueError("Error determining version of openssl library needed by traffic_server executable")
    return self.Condition(
        lambda: exe_ver >= version,
        "openssl library version is " + exe_ver + ", must be at least " + version
    )

def HasCurlFeature(self, feature):

    def default(output):
        FEATURE_TAG = 'Features:'
        tag = feature.lower()
        for line in output.splitlines():
            # look for line with starting with the Features
            if line.startswith(FEATURE_TAG):
                # get a features and lower case then for safety
                line = line[len(FEATURE_TAG):].lower()
                tokens = line.split()
                for t in tokens:
                    if t == tag:
                        return True
        return False

    return self.CheckOutput(
        ['curl', '--version'],
        default,
        "Curl needs to support feature: {feature}".format(feature=feature)
    )


def HasATSFeature(self, feature):

    val = self.Variables.get(feature, None)

    return self.Condition(
        lambda: val == True,
        "ATS feature not enabled: {feature}".format(feature=feature)
    )

#test if a plugin exists in the libexec folder
def PluginExists(self, pluginname):

    path = os.path.join(self.Variables.PLUGINDIR, pluginname)
    return self.Condition(lambda: os.path.isfile(path) == True, path + " not found." )

#test if test is in list in Unix env var TS_AU_TEST_ALLOW
def InEnvAllowList(self, test_name, msg):

    evar_name = "TS_AU_TEST_ALLOW"
    evar = os.environ.get(evar_name, msg)
    if (evar == None):
        evar = ""

    pos = str(" " + evar + " ").find(" " + test_name + " ")

    return self.Condition(
        lambda: pos >= 0, msg + ", and " +  test_name + " not in blank-delimited list of tests in environment variable " + evar_name
    )

#test if predicate function returns true
def General(self, predicate, msg):
    return self.Condition(predicate, msg)

ExtendCondition(HasOpenSSLVersion)
ExtendCondition(HasATSFeature)
ExtendCondition(HasCurlFeature)
ExtendCondition(PluginExists)
ExtendCondition(InEnvAllowList)
ExtendCondition(General)

