{
  "$schema": "https://github.com/apache/trafficserver/tree/master/proxy/http/remap/remap.schema.json",
  "title": "Traffic Server Remap Config",
  "description": "Remap (URL rewriting) configuration. Licensed under Apache V2 https://www.apache.org/licenses/LICENSE-2.0",
  "type": "object",
  "properties": {
    "version": {
      "type": "string",
      "description": "Configuration format version."
    },
    "url_rewrite": {
      "description": "Root tag for URL rewrite configuration",
      "type": "object",
      "properties": {
        "rules": {
          "$ref": "#/definitions/url_rewrite/directive"
        },
        "filters": {
          "$ref": "#/definitions/url_rewrite/filter_define_list"
        }
      }
    }
  },
  "required": [
    "url_rewrite"
  ],
  "definitions": {
    "url_rewrite": {
      "ip_range": {
        "description": "A range of IP addresses in a single family.",
        "anyOf": [
          {
            "type": "array",
            "minItems": 2,
            "maxItems": 2,
            "items": {
              "type": "string",
              "description": "IP address."
            }
          },
          {
            "type": "string",
            "description": "A single IP address, a dash separated pair of IP addresses, or a CIDR notation network."
          }
        ]
      },
      "action": {
        "description": "Filtering result.",
        "type": "string",
        "enum": [
          "disable",
          "enable"
        ]
      },
      "method_set": {
        "description": "Methods to check.",
        "oneOf": [
          {
            "type": "string",
            "description": "Method name"
          },
          {
            "type": "array",
            "description": "List of method names.",
            "minItems": 1,
            "items": {
              "type": "string",
              "description": "Method name"
            }
          }
        ]
      },
      "filter_define": {
        "description": "Required transaction properties to match for a rule to be valid.",
        "type": "object",
        "properties": {
          "name": {
            "description": "Name of the filter.",
            "type": "string"
          },
          "action": {
            "$ref": "#/definitions/url_rewrite/action"
          }
        },
        "required": [
          "name"
        ]
      },
      "filter_define_list": {
        "description": "List of (named) filter definitions.",
        "oneOf": [
          {
            "$ref": "#/definitions/url_rewrite/filter_define"
          },
          {
            "type": "array",
            "minItems": 1,
            "items": {
              "$ref": "#/definitions/url_rewrite/filter_define"
            }
          }
        ]
      },
      "filter_name": {
        "description": "Name of a filter",
        "type": "string"
      },
      "filter_ref": {
        "oneOf": [
          {
            "$ref": "#/definitions/url_rewrite/filter_name"
          },
          {
            "$ref": "#/definitions/url_rewrite/filter_define"
          }
        ]
      },
      "filter_list": {
        "description": "List of filters. These can be filter names or in place definitions.",
        "oneOf": [
          {
            "$ref": "#/definitions/url_rewrite/filter_ref"
          },
          {
            "type": "array",
            "minItems": 1,
            "items": {
              "$ref": "#/definitions/url_rewrite/filter_ref"
            }
          }
        ]
      },
      "plugin": {
        "description": "A plugin to run for a rule.",
        "type": "object",
        "properties": {
          "path": {
            "description": "Path to the plugin binary.",
            "type": "string"
          },
          "args": {
            "description": "Arguments to pass to plugin during rule initialization",
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        },
        "required": [
          "path"
        ]
      },
      "plugin_list": {
        "description": "Set of plugins to run for this rule.",
        "oneOf": [
          {
            "$ref": "#/definitions/url_rewrite/plugin"
          },
          {
            "type": "array",
            "minItems": 1,
            "items": {
              "$ref": "#/definitions/url_rewrite/plugin"
            }
          }
        ]
      },
      "referer_data": {
        "description": "Refererer matching data.",
        "type": "object",
        "properties": {
          "redirect": {
            "description": "Default redirection URL",
            "type": "string"
          },
          "match": {
            "description": "Regular expressions (PCRE compliant) to match the Referer field value.",
            "type": "array",
            "items": {
              "description": "A regular expression",
              "type": "string"
            },
            "minItems": 1
          }
        },
        "required": [
          "redirect",
          "match"
        ]
      },
      "rule_option": {
        "description": "Optional feature for a rule.",
        "type": "string",
        "enum": [
          "reverse"
        ]
      },
      "rule": {
        "description": "URL Rewrite rule.",
        "type": "object",
        "properties": {
          "target": {
            "description": "The original URL in the client request.",
            "type": "string"
          },
          "replacement": {
            "description": "The new URL to which the proxy request should be rewritten.",
            "type": "string"
          },
          "options": {
            "description": "Rule options to enable for this rule.",
            "oneOf": [
              {
                "$ref": "#/definitions/url_rewrite/rule_option"
              },
              {
                "type": "array",
                "items": {
                  "$ref": "#/definitions/url_rewrite/rule_option"
                },
                "minItems": 1
              }
            ]
          },
          "rule_id": {
            "description": "Rule identifier (positive integer)",
            "type": "number"
          },
          "proxy_port": {
            "description": "Specify a local port for a rule.",
            "type": "number"
          },
          "plugins": {
            "$ref": "#/definitions/url_rewrite/plugin_list"
          },
          "referer": {
            "$ref": "#/definitions/url_rewrite/referer_data"
          },
          "filters": {
            "$ref": "#/definitions/url_rewrite/filter_list"
          }
        },
        "required": [
          "target",
          "replacement"
        ]
      },
      "filter_directive_list": {
        "description": "List of filter names.",
        "oneOf": [
          {
            "$ref": "#/definitions/url_rewrite/filter_name"
          },
          {
            "type": "array",
            "minItems": 1,
            "items": {
              "$ref": "#/definitions/url_rewrite/filter_name"
            }
          }
        ]
      },
      "directive": {
        "oneOf": [
          {
            "description": "Filter enable",
            "type": "object",
            "properties": {
              "enable": {
                "$ref": "#/definitions/url_rewrite/filter_directive_list"
              }
            },
            "required": [ "enable" ]
          },
          {
            "description": "Filter disable",
            "type": "object",
            "properties": {
              "enable": {
                "$ref": "#/definitions/url_rewrite/filter_directive_list"
              }
            },
            "required": [ "disable" ]
          },
          {
            "$ref": "#/definitions/url_rewrite/rule"
          },
          {
            "description": "List of directives.",
            "type": "array",
            "minItems": 1,
            "items": {
              "$ref": "#/definitions/url_rewrite/directive"
            }
          }
        ]
      }
    }
  }
}
