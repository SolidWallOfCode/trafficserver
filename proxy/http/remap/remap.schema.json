{
  "$schema": "https://github.com/apache/trafficserver/tree/master/proxy/http/remap/remap.schema.json",
  "title": "Traffic Server Remap Config",
  "description": "Remap (URL rewriting) configuration. Licensed under Apache V2 https://www.apache.org/licenses/LICENSE-2.0",
  "type": "object",
  "properties": {
    "version": {
      "type": "string",
      "description": "Configuration format version."
    },
    "url_rewrite": {
      "description": "Root tag for URL rewrite configuration",
      "type": "object",
      "properties": {
        "rules": {
          "$ref": "#/definitions/url_rewrite/directive_group"
        },
        "filters": {
          "$ref": "#/definitions/url_rewrite/filter_define_group"
        }
      }
    }
  },
  "definitions": {
    "url_rewrite": {
      "ip_range": {
        "description": "A range of IP addresses in a single family.",
        "anyOf": [
          {
            "type": "array",
            "minItems": 2,
            "maxItems": 2,
            "items": {
              "type": "string",
              "description": "IP address."
            }
          },
          {
            "type": "string",
            "description": "A single IP address, a dash separated pair of IP addresses, or a CIDR notation network."
          }
        ]
      },
      "action": {
        "description": "Filtering result.",
        "type": "string",
        "enum": [
          "deny",
          "allow"
        ]
      },
      "method_set": {
        "description": "Methods to check.",
        "oneOf": [
          {
            "type": "string",
            "description": "Method name"
          },
          {
            "type": "array",
            "description": "List of method names.",
            "minItems": 1,
            "items": {
              "type": "string",
              "description": "Method name"
            }
          }
        ]
      },

      "filter_define": {
        "description": "Permission control for a rule.",
        "type": "object",
        "properties": {
          "name": {
            "description": "Name of the filter.",
            "type": "string"
          },
          "action": {
            "$ref": "#/definitions/url_rewrite/action"
          },
          "method": {
            "$ref": "#/definitions/url_rewrite/method_set"
          },
          "proxy_addr": {
            "$ref": "#/definitions/url_rewrite/ip_range"
          },
          "src_addr": {
            "$ref": "#/definitions/url_rewrite/ip_range"
          }
        },
        "required": [
          "name", "action"
        ]
      },

      "filter_define_list": {
        "description": "List of explicit named filter definitions.",
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/url_rewrite/filter_define"
          }
      },

      "filter_define_group": {
        "description": "Explicit named filter definition(s).",
        "oneOf": [
          {
            "$ref": "#/definitions/url_rewrite/filter_define"
          },
          {
            "$ref": "#/definitions/url_rewrite/filter_define_list"
          }
        ]
      },

      "filter_ref": {
        "description": "Reference a filter by name.",
        "type": "string"
      },

      "filter_use": {
        "oneOf": [
          {
            "$ref": "#/definitions/url_rewrite/filter_ref"
          },
          {
            "$ref": "#/definitions/url_rewrite/filter_define"
          }
        ]
      },

      "filter_use_list": {
        "description": "List of filter definitions or names.",
        "type": "array",
        "minItems": 1,
        "items": { "$ref": "#/definitions/url_rewrite/filter_use" }
      },

      "filter_enable_group": {
        "description": "Filter(s) to enable.",
        "oneOf": [
          { "$ref": "#/definitions/url_rewrite/filter_use" },
          { "$ref": "#/definitions/url_rewrite/filter_use_list" }
        ]
      },

      "filter_ref_list": {
        "description": "List of filter names.",
        "type": "array",
        "minItems": 1,
        "items": { "$ref": "#/definitions/url_rewrite/filter_ref" }
      },

      "filter_disable_group": {
        "description": "Filter(s) to disable.",
        "oneOf": [
          { "$ref": "#/definitions/url_rewrite/filter_ref" },
          { "$ref": "#/definitions/url_rewrite/filter_ref_list" }
        ]
      },

      "plugin": {
        "description": "A plugin to run for a rule.",
        "type": "object",
        "properties": {
          "path": {
            "description": "Path to the plugin binary.",
            "type": "string"
          },
          "args": {
            "description": "Arguments to pass to plugin during rule initialization",
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        },
        "required": [
          "path"
        ]
      },

      "plugin_list": {
        "description": "List of plugin definitions.",
        "type": "array",
        "minItems": 1,
        "items": { "$ref": "#/definitions/url_rewrite/plugin" }
      },

      "plugin_group": {
        "description": "Set of plugins to run for this rule.",
        "oneOf": [
          { "$ref": "#/definitions/url_rewrite/plugin" },
          { "$ref": "#/definitions/url_rewrite/plugin_list" }
        ]
      },

      "referer_data": {
        "description": "Refererer matching data.",
        "type": "object",
        "properties": {
          "redirect": {
            "description": "Default redirection URL",
            "type": "string"
          },
          "match": {
            "description": "Regular expressions (PCRE compliant) to match the Referer field value.",
            "type": "array",
            "items": {
              "description": "A regular expression",
              "type": "string"
            },
            "minItems": 1
          }
        },
        "required": [
          "redirect",
          "match"
        ]
      },
      "rule_option": {
        "description": "Optional feature for a rule.",
        "type": "string",
        "enum": [
          "reverse"
        ]
      },

      "rule": {
        "description": "URL Rewrite rule.",
        "type": "object",
        "properties": {
          "target": {
            "description": "The original URL in the client request.",
            "type": "string"
          },
          "replacement": {
            "description": "The new URL to which the proxy request should be rewritten.",
            "type": "string"
          },
          "options": {
            "description": "Rule options to enable for this rule.",
            "oneOf": [
              {
                "$ref": "#/definitions/url_rewrite/rule_option"
              },
              {
                "type": "array",
                "items": {
                  "$ref": "#/definitions/url_rewrite/rule_option"
                },
                "minItems": 1
              }
            ]
          },
          "rule_id": {
            "description": "Rule identifier (positive integer)",
            "type": "number"
          },
          "proxy_port": {
            "description": "Specify a local port for a rule.",
            "type": "number"
          },
          "plugins": {
            "$ref": "#/definitions/url_rewrite/plugin_list"
          },
          "referer": {
            "$ref": "#/definitions/url_rewrite/referer_data"
          },
          "filters": {
            "$ref": "#/definitions/url_rewrite/filter_enable_group"
          }
        },
        "required": [
          "target",
          "replacement"
        ]
      },

      "filter_enable_directive": {
        "description": "Filter(s) to enable.",
        "type": "object",
        "properties": {
          "enable": {
            "$ref": "#/definitions/url_rewrite/filter_enable_group"
          }
        },
        "required": [ "enable" ]
      },

      "filter_disable_directive": {
        "description": "Filter(s) to disable.",
        "type": "object",
        "properties": {
          "disable": {
            "$ref": "#/definitions/url_rewrite/filter_disable_group"
          }
        },
        "required": [ "disable" ]
      },

      "directive": {
        "oneOf": [
          {
            "$ref": "#/definitions/url_rewrite/filter_enable_directive"
          },
          {
            "$ref": "#/definitions/url_rewrite/filter_disable_directive"
          },
          {
            "$ref": "#/definitions/url_rewrite/rule"
          }
        ]
      },

      "directive_list": {
        "description": "List of directives.",
        "type": "array",
        "minItems": 1,
        "items": {
          "$ref": "#/definitions/url_rewrite/directive_group"
        }
      },

      "directive_group": {
        "oneOf": [
          {
            "$ref": "#/definitions/url_rewrite/directive"
          },
          {
            "$ref": "#/definitions/url_rewrite/directive_list"
          }
        ]
      }
    }
  }
}
